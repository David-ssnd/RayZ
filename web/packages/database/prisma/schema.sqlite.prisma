generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

datasource db {
  provider = "sqlite"
}

// ================= USER & AUTH =================

model User {
  id            String     @id @default(uuid())
  email         String     @unique
  emailVerified DateTime?
  name          String?
  image         String?
  password      String?
  role          String     @default("user")
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  profile       Profile?
  accounts      Account[]
  sessions      Session[]
  projects      Project[]
  gameSessions  GameSession[]
  matchParticipations MatchParticipation[]
}

model Profile {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bio       String?
  avatarUrl String?
  devices   Device[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ================= DEVICES =================

model Device {
  id              String      @id @default(uuid())
  deviceId        Int         @unique
  name            String
  role            String
  ipAddress       String?
  lastSeen        DateTime    @default(now())
  status          String      @default("offline")
  firmwareVersion String?
  batteryLevel    Int?
  signalStrength  Int?
  order           Int         @default(0) // Display order in UI
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  profileId       String
  profile         Profile     @relation(fields: [profileId], references: [id], onDelete: Cascade)
  projectId       String?
  project         Project?    @relation(fields: [projectId], references: [id], onDelete: SetNull)
  playerId        String?
  player          Player?     @relation(fields: [playerId], references: [id], onDelete: SetNull)
  weaponId        Int?
  gameSessions    GameSession[]
}

// ================= TEAMS & PLAYERS =================

model Team {
  id        String   @id @default(uuid())
  name      String
  color     String   // Hex Code e.g. "#FF0000"
  
  // PROTOCOL ID: The integer (1-255) sent to ESP32
  number    Int
  
  // Display order in UI
  order     Int      @default(0)

  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  players   Player[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Player {
  id        String   @id @default(uuid())
  name      String

  // PROTOCOL ID: The integer (0-255) sent to ESP32
  // This is NOT the database ID, but the Laser Tag network ID.
  number    Int
  
  // Display order in UI
  order     Int      @default(0)

  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  teamId    String?
  team      Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)
  
  devices   Device[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ================= PROJECTS & GAME MODES =================

model Project {
  id          String      @id @default(uuid())
  name        String
  description String?
  status      String      @default("draft") // draft, active, archived
  
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  gameModeId  String
  gameMode    GameMode    @relation(fields: [gameModeId], references: [id])
  
  devices     Device[]
  players     Player[]
  teams       Team[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  gameSessions GameSession[]
}

model GameMode {
  id              String      @id @default(uuid())
  name            String      @unique
  description     String?
  isSystem        Boolean     @default(false)
  config          String      // JSON stringified config
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  projects        Project[]
  gameSessions    GameSession[]
}

// ================= GAME SESSIONS =================

model GameSession {
  id              String              @id @default(uuid())
  projectId       String
  project         Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  gameModeId      String
  gameMode        GameMode            @relation(fields: [gameModeId], references: [id])
  deviceId        String
  device          Device              @relation(fields: [deviceId], references: [id])
  userId          String
  user            User                @relation(fields: [userId], references: [id])
  startTime       DateTime            @default(now())
  endTime         DateTime?
  status          String              @default("pending")
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  matchParticipations MatchParticipation[]
}

// ================= MATCHES & STATISTICS =================

model Match {
  id              String              @id @default(uuid())
  projectId       String
  gameModeId      String
  sessionId       String?
  startTime       DateTime            @default(now())
  endTime         DateTime?
  status          String              @default("active")
  winner          String?
  winnerTeam      String?
  totalPlayers    Int                 @default(0)
  totalHits       Int                 @default(0)
  totalShots      Int                 @default(0)
  duration        Int?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  matchParticipations MatchParticipation[]
  matchEvents     MatchEvent[]
}

model MatchParticipation {
  id          String      @id @default(uuid())
  matchId     String
  match       Match       @relation(fields: [matchId], references: [id], onDelete: Cascade)
  playerId    String
  user        User        @relation(fields: [playerId], references: [id], onDelete: Cascade)
  sessionId   String?
  gameSession GameSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  deviceRole  String
  teamId      String?
  kills       Int         @default(0)
  deaths      Int         @default(0)
  hits        Int         @default(0)
  shots       Int         @default(0)
  accuracy    Float       @default(0)
  score       Int         @default(0)
  joinedAt    DateTime    @default(now())
  leftAt      DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model MatchEvent {
  id          String   @id @default(uuid())
  matchId     String
  match       Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)
  eventType   String
  timestamp   DateTime @default(now())
  shooterId   String?
  targetId    String?
  teamId      String?
  data        String?  // JSON stringified additional data
  createdAt   DateTime @default(now())
}

// ================= PLAYER STATS =================

model PlayerStats {
  id              String   @id @default(uuid())
  playerId        String   @unique
  totalMatches    Int      @default(0)
  totalKills      Int      @default(0)
  totalDeaths     Int      @default(0)
  totalHits       Int      @default(0)
  totalShots      Int      @default(0)
  accuracy        Float    @default(0)
  totalScore      Int      @default(0)
  highestKillStreak Int    @default(0)
  favoriteWeapon  String?
  totalPlayTime   Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ================= ACHIEVEMENTS & LEADERBOARDS =================

model Achievement {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  icon        String?
  criteria    String   // JSON stringified criteria
  points      Int      @default(0)
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PlayerAchievement {
  id            String   @id @default(uuid())
  playerId      String
  achievementId String
  unlockedAt    DateTime @default(now())
  progress      Int      @default(0)
}

model LeaderboardEntry {
  id          String   @id @default(uuid())
  playerId    String
  category    String
  value       Float
  rank        Int?
  season      String?
  timestamp   DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
